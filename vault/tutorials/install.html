<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Install :: Commodore Components Hub</title>
    <link rel="canonical" href="https://hub.syn.tools/vault/tutorials/install.html">
    <link rel="prev" href="../index.html">
    <link rel="next" href="../references/parameters.html">
    <meta name="generator" content="Antora 2.3.4">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-54393406-10"></script>
    <script>function gtag(){dataLayer.push(arguments)};window.dataLayer=window.dataLayer||[];gtag('js',new Date());gtag('config','UA-54393406-10')</script>
    <script>var uiRootPath = '../../_'</script>
    <script type="text/javascript" id="hs-script-loader" async defer src="//js.hs-scripts.com/7105834.js"></script>
<link rel="apple-touch-icon" sizes="180x180" href="/_/img/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/_/img/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/_/img/favicon-16x16.png">
<link rel="mask-icon" href="/_/img/safari-pinned-tab.svg" color="#5bbad5">
<meta name="msapplication-TileColor" content="#da532c">
<meta name="theme-color" content="#ffffff">
  </head>
  <body class="article">
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <div class="navbar-item">
        <div class="syn_logo"></div>
        <a href="https://hub.syn.tools">Commodore Components Hub
          </a>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">Tools</a>
          <div class="navbar-dropdown">
            <a class="navbar-item" href="https://syn.tools/commodore/">Commodore</a>
            <a class="navbar-item" href="https://hub.syn.tools/" target="_blank" >Commodore Components Hub</a>
            <a class="navbar-item" href="https://syn.tools/lieutenant-api/">Lieutenant API</a>
            <a class="navbar-item" href="https://syn.tools/lieutenant-operator/">Lieutenant Operator</a>
            <a class="navbar-item" href="https://syn.tools/steward/">Steward</a>
            <a class="navbar-item" href="https://k8up.io/" target="_blank">K8up</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="#">
            <div class="vshn-unified-logo"></div>
          </a>
          <div class="navbar-dropdown">
            <a class="navbar-item" target="_blank" href="https://www.vshn.ch/">Main website</a>
            <a class="navbar-item" target="_blank" href="https://handbook.vshn.ch/">Handbook</a>
            <a class="navbar-item" target="_blank" href="https://kb.vshn.ch/">Knowledge Base</a>
            <a class="navbar-item" target="_blank" href="https://products.docs.vshn.ch/">Products</a>
            <a class="navbar-item" target="_blank" href="https://legal.docs.vshn.ch/">Legal</a>
            <a class="navbar-item" target="_blank" href="https://control.docs.vshn.ch/">Portal Help</a>
            <a class="navbar-item" target="_blank" href="https://docs.appuio.ch/">APPUiO Documentation</a>
          </div>
        </div>
        <div class="navbar-item">
          <div class="search-field">
            <input id="search-input" class="search-input" type="search" placeholder="Search">
            <button type="submit" class="search-button">
              <i class="fa fa-search"></i>
            </button>
          </div>
        </div>
        <div class="navbar-item">
          <a class="navbar-item" href="https://github.com/projectsyn/" target="_blank"><i
              class="fa fa-github" style="font-size: 30px;"></i>&nbsp;
            GitHub</a>
        </div>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="vault" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../index.html">vault</a></h3>
<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../index.html">Home</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="install.html">Installation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../references/parameters.html">Parameters</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
<div class="nav-panel-explore" data-panel="explore">
  <div class="context">
    <span class="title">vault</span>
    <span class="version">master</span>
  </div>
  <ul class="components">
    <li class="component">
      <a class="title" href="../../adhoc-configurations/index.html">adhoc-configurations</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../adhoc-configurations/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../argocd/index.html">Argo CD</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../argocd/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../azuredisk-csi-driver/index.html">azuredisk-csi-driver</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../azuredisk-csi-driver/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../backup-k8up/index.html">backup-k8up</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../backup-k8up/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../cert-manager/index.html">cert-manager</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../cert-manager/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../cluster-autoscaler/index.html">cluster-autoscaler</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../cluster-autoscaler/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../cluster-backup/index.html">cluster-backup</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../cluster-backup/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../hub/index.html">Commodore Components Hub</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../hub/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../coredns/index.html">coredns</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../coredns/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../crossplane/index.html">Crossplane</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../crossplane/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../csi-cloudscale/index.html">csi-cloudscale</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../csi-cloudscale/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../csi-driver-smb/index.html">csi-driver-smb</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../csi-driver-smb/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../eks-addon-manager/index.html">eks-addon-manager</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../eks-addon-manager/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../espejo/index.html">Espejo</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../espejo/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../eventrouter/index.html">eventrouter</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../eventrouter/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../external-dns/index.html">external-dns</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../external-dns/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../fluentbit/index.html">fluentbit</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../fluentbit/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../fortune/index.html">fortune</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../fortune/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../grafana-helm/index.html">grafana-helm</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../grafana-helm/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../ingress-nginx/index.html">ingress-nginx</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../ingress-nginx/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../keycloak/index.html">keycloak</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../keycloak/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../metrics-server/index.html">Kubernetes Metrics Server</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../metrics-server/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../kyverno/index.html">kyverno</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../kyverno/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../lieutenant/index.html">Lieutenant</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../lieutenant/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../machineset-egress-cidr-operator/index.html">machineset-egress-cidr-operator</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../machineset-egress-cidr-operator/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../metallb/index.html">metallb</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../metallb/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../minio/index.html">minio</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../minio/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../networkpolicy/index.html">NetworkPolicy</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../networkpolicy/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../nfs-subdir-external-provisioner/index.html">nfs-subdir-external-provisioner</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../nfs-subdir-external-provisioner/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../openshift4-authentication/index.html">OpenShift 4 Authentication</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../openshift4-authentication/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../openshift4-local-storage/index.html">OpenShift 4 local-storage</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../openshift4-local-storage/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../openshift4-nodes/index.html">OpenShift 4 Machine Management</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../openshift4-nodes/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../openshift4-registry/index.html">OpenShift 4 Registry</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../openshift4-registry/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../openshift4-version/index.html">OpenShift 4 Version</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../openshift4-version/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../openshift-prometheus-proxy/index.html">openshift-prometheus-proxy</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../openshift-prometheus-proxy/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../openshift4-console/index.html">OpenShift4 Console</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../openshift4-console/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../openshift4-logging/index.html">OpenShift4 Logging</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../openshift4-logging/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../openshift4-monitoring/index.html">OpenShift4 Monitoring</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../openshift4-monitoring/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../openshift4-scheduling/index.html">OpenShift4 Scheduler</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../openshift4-scheduling/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../openshift4-splunk-forwarder/index.html">Openshift4 Splunk Forwarder</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../openshift4-splunk-forwarder/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../openshift4-ingress/index.html">openshift4-ingress</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../openshift4-ingress/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../openshift4-operators/index.html">openshift4-operators</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../openshift4-operators/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../openshift4-terraform/index.html">openshift4-terraform</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../openshift4-terraform/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../podsecuritypolicy/index.html">podsecuritypolicy</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../podsecuritypolicy/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../prom-label-proxy/index.html">prom-label-proxy</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../prom-label-proxy/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../prometheus-pushgateway/index.html">prometheus-pushgateway</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../prometheus-pushgateway/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../rancher-monitoring/index.html">rancher-monitoring</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../rancher-monitoring/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../registry-cache/index.html">registry-cache</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../registry-cache/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../resource-locker/index.html">Resource Locker Operator</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../resource-locker/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../rook-ceph/index.html">Rook Ceph</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../rook-ceph/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../secret-generator/index.html">secret-generator</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../secret-generator/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../signalilo/index.html">signalilo</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../signalilo/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../statefulset-resize-controller/index.html">statefulset-resize-controller</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../statefulset-resize-controller/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../steward/index.html">Steward</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../steward/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../storageclass/index.html">StorageClass</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../storageclass/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../system-upgrade-controller/index.html">system-upgrade-controller</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../system-upgrade-controller/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../openshift4-cloudscale/index.html">Terraform OpenShift4 cloudscale.ch</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../openshift4-cloudscale/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../thanos/index.html">Thanos</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../thanos/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../topolvm/index.html">TopoLVM</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../topolvm/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../traefik/index.html">traefik</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../traefik/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component is-current">
      <a class="title" href="../index.html">vault</a>
      <ul class="versions">
        <li class="version is-current is-latest">
          <a href="../index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../vault-secrets-operator/index.html">vault-secrets-operator</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../vault-secrets-operator/index.html">master</a>
        </li>
      </ul>
    </li>
    <li class="component">
      <a class="title" href="../../velero/index.html">velero</a>
      <ul class="versions">
        <li class="version is-latest">
          <a href="../../velero/index.html">master</a>
        </li>
      </ul>
    </li>
  </ul>
</div>
    </div>
  </aside>
</div>
<main class="article">
<div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../hub/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../index.html">vault</a></li>
    <li><a href="install.html">Installation</a></li>
  </ul>
</nav>
  <div class="edit-this-page"><a href="https://github.com/projectsyn/component-vault/edit/master/docs/modules/ROOT/pages/tutorials/install.adoc">Edit this Page</a></div>
  </div>
  <div class="content">
<aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
<article class="doc">
<h1 class="page">Install</h1>
<div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>To install Vault using this component, there are a few things to decide and prepare.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_backups"><a class="anchor" href="#_backups"></a>Backups</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, backups using <a href="https://k8up.io/k8up/1.0.0/index.html">k8up</a> are enabled.
For this to work <code>k8up</code> needs to be installed on the same cluster using the <a href="https://github.com/projectsyn/component-backup-k8up">k8up component</a>.</p>
</div>
<div class="paragraph">
<p>By default, the component uses the following configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">backup:
  enabled: true
  schedule: '*/13 * * * *'
  keepjobs: 5
  password: '?{vaultkv:${customer:name}/${cluster:name}/vault/${_instance}/backup/password}'
  bucket:
    name: '${_instance}-backup'
    accesskey: '?{vaultkv:${customer:name}/${cluster:name}/vault/${_instance}/backup/s3_access_key}'
    secretkey: '?{vaultkv:${customer:name}/${cluster:name}/vault/${_instance}/backup/s3_secret_key}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>The backup configuration expects that there is a bucket with the name <code>${INSTANCE}-backup</code>.</p>
</div>
<div class="paragraph">
<p>The three referenced secrets need to be added to the Vault instance associated with the Lieutenant instance managing the cluster on which this component is installed:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The password to use for backup encryption in key <code>clusters/kv/${TENANT_ID}/${CLUSTER_ID}/vault/${INSTANCE}/backup/password}</code></p>
</li>
<li>
<p>The access key for the bucket in key <code>clusters/kv/${TENANT_ID}/${CLUSTER_ID}/vault/${INSTANCE}/backup/s3_access_key}</code></p>
</li>
<li>
<p>The secret key for the bucket in key <code>clusters/kv/${TENANT_ID}/${CLUSTER_ID}/vault/${INSTANCE}/backup/s3_secret_key}</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Unless you explicitly configure multiple instances of the component, a single vault instance will be deployed.
In this case, <code>${INSTANCE}</code> will simply be <code>vault</code>.
See <a href="#_multiple_instances">Multiple Instances</a> for more details on how to deploy multiple Vault instances using this component.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_ldap"><a class="anchor" href="#_ldap"></a>LDAP</h2>
<div class="sectionbody">
<div class="paragraph">
<p>By default, only the backup service account and the root user has access to vault.
You have the option to add more authentication methods and policies.
Here is an example to add Vault access to all people in an LDAP group.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">config:
  auth:
    - type: ldap
      description: LDAP auth
      options:
        listing_visibility: "unauth"
      config:
        url: ldaps://ldap.server.net:636
        binddn: "uid=vault-service,ou=Special Users,dc=server,dc=net"
        bindpass: '?{vaultkv:${customer:name}/${cluster:name}/vault/${_instance}/ldappass}'
        userattr: uid
        userdn: "ou=vault,ou=Service Access,ou=Views,dc=server,dc=net"
        groupdn: "ou=Groups,dc=vshn,dc=net"
        groupattr: cn
      groups:
        vault-root:
          policies: cluster-root
  policies:
    - name: cluster-root
      rules: |
        path "clusters/*" {
          capabilities = ["create", "read", "update", "delete", "list"]
        }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Under the hood, this component uses <code>bank-vaults</code> to configure vault.
<a href="https://banzaicloud.com/docs/bank-vaults/external-configuration/">This reference</a> provides more details on how to configure policies and authentication methods.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_lieutenant_integration"><a class="anchor" href="#_lieutenant_integration"></a>Lieutenant Integration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If your Vault should interact with a Lieutenant instance, we need to add some policies and authentication methods.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">config:
  policies:
    - name: syn-cluster
      rules: | # Allow to get cluster's own secrets
        path "clusters/kv/data/+/{{identity.entity.aliases.auth_kubernetes_5b636428.metadata.service_account_name}}/*" {
          capabilities = ["read"]
        }
    - name: lieutenant-operator
      rules: |
        path "clusters/kv/data/*" {
          capabilities = ["read", "create", "update", "delete"]
        }
        path "clusters/kv/metadata/*" {
          capabilities = ["read", "create", "update", "delete", "list"]
        }
        path "clusters/kv/delete/*" {
          capabilities = ["update"]
        }
  auth:
    - type: kubernetes
      roles:
        - name: syn-cluster
          bound_service_account_names: "*"
          bound_service_account_namespaces: lieutenant-prod
          policies: syn-cluster
          ttl: 1h
        - name: lieutenant-operator
          bound_service_account_names: lieutenant-operator
          bound_service_account_namespaces: lieutenant-prod
          policies: lieutenant-operator
          ttl: 1h</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>syn-cluster</code> policy allows each cluster to reveal its own secrets.
The <code>lieutenant-operator</code> policy the <code>lieutenant-operator</code> to read and write secrets.</p>
</div>
<div class="paragraph">
<p>This setup expects Vault and Lieutenant to be deployed in the same cluster.
If service accounts or namespaces differ in your deployment, you will need to update the snippet above.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>The policy <code>syn-cluster</code> allows ArgoCD to read the secrets of its cluster.
The templating entry <code>auth_kubernetes_5b636428</code> is a name generated by vault on first startup.
This means the policy needs to be added one a second deployment after fetching the name from the deployed Vault.</p>
</div>
<div class="paragraph">
<p>The entry is the <em>Accessor</em> name of the Kubernetes authentication method.
If can either be fetched from the UI on the <em>Access</em> tab or from the CLI with:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-bash hljs" data-lang="bash">vault auth list -detailed</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_multiple_instances"><a class="anchor" href="#_multiple_instances"></a>Multiple Instances</h2>
<div class="sectionbody">
<div class="paragraph">
<p>This component is able to deploy multiple instances of Vault on the same cluster.
You can deploy multiple instances of Vault by instantiating the component.
The following configuration creates two Vault instances named <code>vault-prod</code> and <code>vault-test</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-yaml hljs" data-lang="yaml">applications:
  - vault as vault-prod
  - vault as vault-test
parameters:
  vault_prod:
    config:
      auth:
        - type: ldap
          description: LDAP auth
          options:
            listing_visibility: "unauth"
          config:
            url: ldaps://ldap.server.net:636
            binddn: "uid=vault-service,ou=Special Users,dc=server,dc=net"
            bindpass: '?{vaultkv:${customer:name}/${cluster:name}/vault/${_instance}/ldappass}'
            userattr: uid
            userdn: "ou=vault,ou=Service Access,ou=Views,dc=server,dc=net"
            groupdn: "ou=Groups,dc=vshn,dc=net"
            groupattr: cn
          groups:
            vault-root:
              policies: cluster-root
      policies:
        - name: cluster-root
          rules: |
            path "clusters/*" {
              capabilities = ["create", "read", "update", "delete", "list"]
            }
  vault_test:
    backup:
      enabled: false</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will deploy a production vault with LDAP access named <code>vault-prod</code> to the namespace <code>vault-prod</code>.
And a test vault without backups named <code>vault-test</code> to the namespace <code>vault-test</code>.</p>
</div>
<div class="paragraph">
<p>When instantiating a component the <code>${INSTANCE}</code> parameter is set to the instance&#8217;s name.
For the production Vault, the parameter is set to <code>vault-prod</code> and for the test Vault it&#8217;s set to <code>vault-test</code>.</p>
</div>
<div class="paragraph">
<p>There are some things to consider when deploying multiple instances of Vault:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>No two instances are allowed to have the same name.
This includes instances of other components.
You should never name an instance the same name as other components.
Naming your Vault instance <code>argocd</code> can break in unexpected ways.
In general it&#8217;s a good idea to prefix your instance with <code>vault-</code>.</p>
</li>
<li>
<p>You can overwrite both the name and namespace of the instance.
Two instances can either have the same name or be in the same namespace.
If two instances have the same name and namespace bad things will break in unexpected ways.</p>
</li>
<li>
<p>If two instances are deployed to the same namespace, they can in principle read each others secrets.
This means in practice you will want to put the production vault in a separate namespace.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>More information on how component instantiation works can be found <a href="https://syn.tools/commodore/reference/architecture.html#_component_instantiation">here</a>.</p>
</div>
</div>
</div>
<nav class="pagination">
  <span class="prev"><a href="../index.html">Home</a></span>
  <span class="next"><a href="../references/parameters.html">Parameters</a></span>
</nav>
</article>
  </div>
</main>
</div>
<footer class="footer">
  <p>Copyright © VSHN 2021 – All Rights Reserved. <a href="https://vshn.ch/en/privacy-policy/">Privacy Policy</a>, <a href="https://vshn.ch/en/imprint/">Imprint</a>, and <a href="https://vshn.ch/en/contact/">Contact</a>.</p>
</footer>
<script src="../../_/js/site.js"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/vendor/search.js" id="search-script" data-base-path="../.." data-page-path="/vault/tutorials/install.html"></script>
<script async src="../../_/../search-index.js"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script type="text/javascript" async src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.6/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<script type="text/x-mathjax-config">
MathJax.Hub.Config({
  messageStyle: "none",
  tex2jax: {
    inlineMath: [["\\(", "\\)"]],
    displayMath: [["\\[", "\\]"]],
    ignoreClass: "nostem|nolatexmath"
  },
  asciimath2jax: {
    delimiters: [["\\$", "\\$"]],
    ignoreClass: "nostem|noasciimath"
  },
  TeX: { equationNumbers: { autoNumber: "none" } }
});
</script>
  </body>
</html>
